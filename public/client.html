<!DOCTYPE html>
<html>
<head>
  <title>Tracking...</title>
  <script>
    // async function trackAndRedirect() {
    //   const params = new URLSearchParams(window.location.search);
    //   const id = params.get('id');
    //   console.log('Incoming query:', Object.fromEntries(params.entries()));

    //   if (!id) {
    //     console.error('Missing tracking ID');
    //     return;
    //   }

    //   // Fetch destination URL from backend
    //     try {
    //         const res = await fetch(`/api/link/${id}`);
    //         if (!res.ok) throw new Error(`Server responded with ${res.status}`);
    //         const data = await res.json();
    //         console.log('Fetched link data:', data);
    //         const target = data.originalUrl;
            
    //         if (!target) {
    //             console.error('Destination not found');
    //             return;
    //         }
    //         // Get location
    //         const position = await new Promise((resolve, reject) =>
    //             navigator.geolocation.getCurrentPosition(resolve, reject)
    //         );

    //         // Send location to backend
    //         await fetch('/api/track', {
    //             method: 'POST',
    //             headers: { 'Content-Type': 'application/json' },
    //             body: JSON.stringify({
    //             id,
    //             location: {
    //                 lat: position.coords.latitude,
    //                 lng: position.coords.longitude
    //             }
    //             })
    //         });

    //         // Redirect
    //         window.location.href = target;

    //     } catch (err) {
    //         console.error('Failed to fetch link:', err);
    //     }

    // }
    // window.onload = trackAndRedirect;


    async function trackAndRedirect() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        if (!id) return console.error('Missing tracking ID');

        // Show loading message
        document.body.innerHTML = '<p>Preparing redirect...</p>';

        // Phase 1: Fetch link with retry
        let data;
        for (let attempt = 1; attempt <= 3; attempt++) {
            try {
            const res = await fetch(`/api/link/${id}`);
            if (res.ok) {
                data = await res.json();
                break;
            }
            } catch (err) {
            console.warn(`Attempt ${attempt} failed`, err);
            }
            await new Promise(r => setTimeout(r, 500));
        }

        if (!data || !data.originalUrl) {
            document.body.innerHTML = '<p>Link not found.</p>';
            return;
        }

        let done = false;
        // Phase 2: Request geolocation
        let location = null;
        try {
            location = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000, // 10s max wait
                maximumAge: 0
            });
            });
        } catch (err) {
            console.warn('Geolocation failed or denied:', err);
        }

        // Phase 3: Send tracking info
        try {
            await fetch('/api/track', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id,
                location: location
                ? {
                    lat: location.coords.latitude,
                    lng: location.coords.longitude,
                    }
                : null,
            }),
            });
            done = true;
        } catch (err) {
            console.warn('Tracking failed:', err);
            done = true;
        }

        // Phase 4: Redirect
        while(!done) await new Promise(r => setTimeout(r, 100));
        window.location.href = data.originalUrl;
    }

    window.onload = trackAndRedirect;

  </script>
</head>
<body>
  <p>Redirecting...</p>
</body>
</html>